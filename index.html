<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Productivity App</title>
  <script src="https://cdn.tailwindcss.com/3.4.1"></script>
</head>
<body class="bg-gray-100 font-sans antialiased">
  <div class="max-w-md mx-auto min-h-screen flex flex-col">
    <!-- Header: Level and EXP -->
    <div class="bg-indigo-600 text-white p-4 sticky top-0 z-10 shadow-md">
      <h1 class="text-xl font-semibold">Level <span id="level">0</span></h1>
      <div class="text-sm mt-1">EXP: <span id="exp">0</span>/<span id="exp-required">40</span></div>
      <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
        <div id="exp-progress" class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
      </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="hidden bg-red-500 text-white p-3 rounded-lg mx-4 mt-4 text-sm"></div>

    <!-- Task Section -->
    <div class="flex-1 p-4 space-y-4">
      <div class="bg-white p-4 rounded-lg shadow-sm">
        <input id="task-title" type="text" placeholder="Task Title" class="w-full p-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-300">
        <textarea id="task-desc" placeholder="Description" class="w-full p-2 border rounded-lg mt-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-300"></textarea>
        <div class="flex gap-2 mt-2">
          <select id="task-priority" class="w-full p-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-300">
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
          </select>
          <select id="task-category" class="w-full p-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-300">
            <option value="Mind">Mind</option>
            <option value="Brain">Brain</option>
            <option value="Health">Health</option>
            <option value="Social">Social</option>
            <option value="Relationships">Relationships</option>
          </select>
        </div>
        <input id="task-deadline" type="date" class="w-full p-2 border rounded-lg mt-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-300">
        <button onclick="addTask()" class="w-full bg-indigo-600 text-white p-2 rounded-lg mt-2 hover:bg-indigo-700 transition text-sm">Add Task</button>
      </div>
      <div id="task-list" class="space-y-4"></div>
    </div>

    <!-- Pomodoro Timer -->
    <div class="bg-white p-4 shadow-t-md sticky bottom-0">
      <h3 class="text-lg font-medium">Pomodoro: <span id="pomodoro-time">25:00</span></h3>
      <div class="text-sm">Session: <span id="pomodoro-session">Work</span> (<span id="pomodoro-count">0</span>/4)</div>
      <div class="flex gap-2 mt-2">
        <button onclick="startPomodoro()" class="flex-1 bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition text-sm">Start</button>
        <button onclick="resumePomodoro()" class="flex-1 bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition text-sm">Resume</button>
        <button onclick="restartPomodoro()" class="flex-1 bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition text-sm">Restart</button>
      </div>
    </div>

    <!-- Sidebar: Analytics -->
    <button class="fixed top-4 right-4 bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition text-sm z-20" onclick="toggleSidebar()">Analytics</button>
    <div id="sidebar" class="fixed top-0 right-[-100%] w-4/5 max-w-xs h-full bg-white shadow-lg p-4 transition-all duration-300 overflow-y-auto">
      <h2 class="text-lg font-semibold mb-4">Analytics</h2>
      <h3 class="text-md font-medium">Daily Report</h3>
      <p class="text-sm">Tasks Completed: <span id="daily-tasks">0</span></p>
      <p class="text-sm">EXP Change: <span id="daily-exp">0</span></p>
      <p class="text-sm">Pomodoro Sessions: <span id="daily-pomodoro">0</span></p>
      <h3 class="text-md font-medium mt-4">Weekly Report</h3>
      <p class="text-sm">Tasks Completed: <span id="weekly-tasks">0</span></p>
      <p class="text-sm">EXP Earned: <span id="weekly-exp">0</span></p>
      <p class="text-sm">Streak: <span id="weekly-streak">0</span> days</p>
      <h3 class="text-md font-medium mt-4">Monthly Report</h3>
      <p class="text-sm">Tasks Completed: <span id="monthly-tasks">0</span></p>
      <p class="text-sm">EXP Earned: <span id="monthly-exp">0</span></p>
    </div>
  </div>

  <script>
    // Initialize state
    let user = {
      level: 0,
      exp: 0,
      expRequired: 40,
      tasks: [],
      pomodoroCount: 0,
      pomodoroSession: 'Work',
      pomodoroTime: 25 * 60,
      dailyTasks: 0,
      dailyExp: 0,
      dailyPomodoro: 0,
      weeklyTasks: 0,
      weeklyExp: 0,
      weeklyStreak: 0,
      monthlyTasks: 0,
      monthlyExp: 0,
      lastActivityDate: null,
      streakTasks: {},
      lastPomodoroDate: null,
      stagnationDays: 0
    };

    // Load from localStorage
    function loadState() {
      const saved = localStorage.getItem('productivityApp');
      if (saved) {
        user = JSON.parse(saved);
        updateUI();
        checkDailyPenalties();
      }
    }

    // Save to localStorage
    function saveState() {
      localStorage.setItem('productivityApp', JSON.stringify(user));
    }

    // Calculate EXP needed for next level
    function getExpRequired(level) {
      return 40 + (level * 10);
    }

    // Update UI
    function updateUI() {
      document.getElementById('level').textContent = user.level;
      document.getElementById('exp').textContent = user.exp;
      document.getElementById('exp-required').textContent = user.expRequired;
      const progress = (user.exp / user.expRequired) * 100;
      document.getElementById('exp-progress').style.width = `${progress}%`;
      renderTasks();
      updateAnalytics();
    }

    // Add Task
    function addTask() {
      const title = document.getElementById('task-title').value;
      const desc = document.getElementById('task-desc').value;
      const priority = document.getElementById('task-priority').value;
      const category = document.getElementById('task-category').value;
      const deadline = document.getElementById('task-deadline').value;

      if (!title) return alert('Task title is required');

      const task = {
        id: Date.now(),
        title,
        desc,
        priority,
        category,
        deadline: deadline ? new Date(deadline).toISOString() : null,
        subtasks: [],
        completed: false
      };

      user.tasks.push(task);
      if (!user.streakTasks[category]) user.streakTasks[category] = { days: 0, lastDate: null };
      saveState();
      updateUI();
      document.getElementById('task-title').value = '';
      document.getElementById('task-desc').value = '';
      document.getElementById('task-deadline').value = '';
    }

    // Render Tasks
    function renderTasks() {
      const taskList = document.getElementById('task-list');
      taskList.innerHTML = '';
      user.tasks.forEach(task => {
        const taskItem = document.createElement('div');
        taskItem.className = 'bg-white p-4 rounded-lg shadow-sm';
        const completedSubtasks = task.subtasks.filter(s => s.completed).length;
        const progress = task.subtasks.length ? (completedSubtasks / task.subtasks.length) * 100 : 100;
        taskItem.innerHTML = `
          <div class="flex justify-between">
            <h3 class="text-md font-medium">${task.title}</h3>
            <span class="text-sm text-gray-500">${task.priority}</span>
          </div>
          <p class="text-sm text-gray-600">${task.desc}</p>
          <p class="text-sm text-gray-500">Category: ${task.category}</p>
          <p class="text-sm text-gray-500">Deadline: ${task.deadline ? new Date(task.deadline).toLocaleDateString() : 'None'}</p>
          <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
            <div class="bg-indigo-500 h-2 rounded-full" style="width: ${progress}%"></div>
          </div>
          <div class="flex gap-2 mt-2">
            <input id="subtask-${task.id}" type="text" placeholder="Add Subtask" class="flex-1 p-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-300">
            <button onclick="addSubtask(${task.id})" class="bg-indigo-600 text-white px-3 py-1 rounded-lg hover:bg-indigo-700 transition text-sm">Add</button>
          </div>
          <div class="flex gap-2 mt-2">
            <button onclick="completeTask(${task.id})" class="flex-1 bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition text-sm">${task.completed ? 'Undo' : 'Complete'}</button>
            <button onclick="deleteTask(${task.id})" class="flex-1 bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition text-sm">Delete</button>
          </div>
          <div id="subtasks-${task.id}" class="mt-2 space-y-2"></div>
        `;
        taskList.appendChild(taskItem);
        renderSubtasks(task.id);
      });
    }

    // Add Subtask
    function addSubtask(taskId) {
      const input = document.getElementById(`subtask-${taskId}`);
      const title = input.value;
      if (!title) return alert('Subtask title is required');
      const task = user.tasks.find(t => t.id === taskId);
      task.subtasks.push({ id: Date.now(), title, completed: false, lastTouched: new Date().toISOString() });
      input.value = '';
      saveState();
      updateUI();
    }

    // Render Subtasks
    function renderSubtasks(taskId) {
      const subtaskList = document.getElementById(`subtasks-${taskId}`);
      const task = user.tasks.find(t => t.id === taskId);
      subtaskList.innerHTML = '';
      task.subtasks.forEach(subtask => {
        const subtaskItem = document.createElement('div');
        subtaskItem.className = 'flex items-center gap-2';
        subtaskItem.innerHTML = `
          <input type="checkbox" ${subtask.completed ? 'checked' : ''} onchange="toggleSubtask(${taskId}, ${subtask.id})" class="h-4 w-4 text-indigo-600 focus:ring-indigo-300">
          <span class="text-sm ${subtask.completed ? 'line-through text-gray-500' : ''}">${subtask.title}</span>
          <button onclick="deleteSubtask(${taskId}, ${subtask.id})" class="ml-auto text-red-500 hover:text-red-600 text-sm">Delete</button>
        `;
        subtaskList.appendChild(subtaskItem);
      });
    }

    // Toggle Subtask
    function toggleSubtask(taskId, subtaskId) {
      const task = user.tasks.find(t => t.id === taskId);
      const subtask = task.subtasks.find(s => s.id === subtaskId);
      subtask.completed = !subtask.completed;
      subtask.lastTouched = new Date().toISOString();
      task.completed = task.subtasks.every(s => s.completed);
      if (task.completed) {
        user.exp += 10;
        user.dailyTasks += 1;
        user.weeklyTasks += 1;
        user.monthlyTasks += 1;
        user.dailyExp += 10;
        user.weeklyExp += 10;
        user.monthlyExp += 10;
        checkLevelUp();
        updateStreaks(task.category);
      }
      saveState();
      updateUI();
    }

    // Delete Subtask
    function deleteSubtask(taskId, subtaskId) {
      const task = user.tasks.find(t => t.id === taskId);
      task.subtasks = task.subtasks.filter(s => s.id !== subtaskId);
      task.completed = task.subtasks.every(s => s.completed);
      saveState();
      updateUI();
    }

    // Complete Task
    function completeTask(taskId) {
      const task = user.tasks.find(t => t.id === taskId);
      task.completed = !task.completed;
      task.subtasks.forEach(s => s.completed = task.completed);
      if (task.completed) {
        user.exp += 10;
        user.dailyTasks += 1;
        user.weeklyTasks += 1;
        user.monthlyTasks += 1;
        user.dailyExp += 10;
        user.weeklyExp += 10;
        user.monthlyExp += 10;
        checkLevelUp();
        updateStreaks(task.category);
      }
      saveState();
      updateUI();
    }

    // Delete Task
    function deleteTask(taskId) {
      user.tasks = user.tasks.filter(t => t.id !== taskId);
      saveState();
      updateUI();
    }

    // Check Level Up
    function checkLevelUp() {
      while (user.exp >= user.expRequired) {
        user.level += 1;
        user.exp -= user.expRequired;
        user.expRequired = getExpRequired(user.level);
      }
    }

    // Update Streaks
    function updateStreaks(category) {
      const today = new Date().toDateString();
      if (user.streakTasks[category].lastDate !== today) {
        user.streakTasks[category].days += 1;
        user.streakTasks[category].lastDate = today;
        user.weeklyStreak = Math.max(user.weeklyStreak, user.streakTasks[category].days);
        if (user.streakTasks[category].days >= 5) {
          showNotification('You’ve earned a break day for your ' + category + ' streak!');
        }
      }
    }

    // Pomodoro Timer
    let pomodoroInterval = null;
    function startPomodoro() {
      if (pomodoroInterval) return;
      pomodoroInterval = setInterval(() => {
        user.pomodoroTime -= 1;
        if (user.pomodoroTime <= 0) {
          if (user.pomodoroSession === 'Work') {
            user.exp += 5;
            user.dailyExp += 5;
            user.weeklyExp += 5;
            user.monthlyExp += 5;
            user.dailyPomodoro += 1;
            user.pomodoroCount += 1;
            user.pomodoroSession = user.pomodoroCount % 4 === 0 ? 'Long Break' : 'Break';
            user.pomodoroTime = user.pomodoroSession === 'Long Break' ? 15 * 60 : 5 * 60;
            if (user.pomodoroCount % 4 === 0) user.pomodoroCount = 0;
          } else {
            user.pomodoroSession = 'Work';
            user.pomodoroTime = 25 * 60;
          }
        }
        updatePomodoroUI();
        saveState();
      }, 1000);
    }

    function resumePomodoro() {
      if (!pomodoroInterval) startPomodoro();
    }

    function restartPomodoro() {
      clearInterval(pomodoroInterval);
      pomodoroInterval = null;
      user.pomodoroTime = 25 * 60;
      user.pomodoroSession = 'Work';
      user.pomodoroCount = 0;
      user.exp -= 1;
      user.dailyExp -= 1;
      showNotification('Pomodoro canceled. -1 EXP');
      updatePomodoroUI();
      saveState();
    }

    function updatePomodoroUI() {
      const minutes = Math.floor(user.pomodoroTime / 60);
      const seconds = user.pomodoroTime % 60;
      document.getElementById('pomodoro-time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      document.getElementById('pomodoro-session').textContent = user.pomodoroSession;
      document.getElementById('pomodoro-count').textContent = user.pomodoroCount;
    }

    // Analytics
    function updateAnalytics() {
      document.getElementById('daily-tasks').textContent = user.dailyTasks;
      document.getElementById('daily-exp').textContent = user.dailyExp;
      document.getElementById('daily-pomodoro').textContent = user.dailyPomodoro;
      document.getElementById('weekly-tasks').textContent = user.weeklyTasks;
      document.getElementById('weekly-exp').textContent = user.weeklyExp;
      document.getElementById('weekly-streak').textContent = user.weeklyStreak;
      document.getElementById('monthly-tasks').textContent = user.monthlyTasks;
      document.getElementById('monthly-exp').textContent = user.monthlyExp;
    }

    // Sidebar Toggle
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('right-[-100%]');
      sidebar.classList.toggle('right-0');
    }

    // Notifications
    function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.classList.remove('hidden');
      setTimeout(() => notification.classList.add('hidden'), 3000);
    }

    // Daily Penalties and Checks
    function checkDailyPenalties() {
      const today = new Date().toDateString();
      if (user.lastActivityDate !== today) {
        let hasTasks = user.tasks.some(t => !t.completed);
        if (hasTasks) {
          user.exp -= 5;
          user.dailyExp -= 5;
          showNotification('Missed tasks yesterday. -5 EXP');
        } else if (user.dailyTasks > 0) {
          user.exp += 5;
          user.dailyExp += 5;
          showNotification('Daily check-in bonus: +5 EXP');
        }
        if (user.lastPomodoroDate !== today && user.dailyPomodoro === 0) {
          user.exp -= 2;
          user.dailyExp -= 2;
          showNotification('No Pomodoro sessions yesterday. -2 EXP');
        }
        user.streakTasks = Object.keys(user.streakTasks).reduce((acc, category) => {
          if (user.streakTasks[category].lastDate !== today && user.streakTasks[category].days < 5) {
            acc[category] = { days: 0, lastDate: null };
            user.exp -= 3;
            user.dailyExp -= 3;
            showNotification(`Broke ${category} streak. -3 EXP`);
          } else {
            acc[category] = user.streakTasks[category];
          }
          return acc;
        }, {});
        user.tasks.forEach(task => {
          task.subtasks.forEach(subtask => {
            const lastTouched = new Date(subtask.lastTouched);
            const daysSince = Math.floor((new Date() - lastTouched) / (1000 * 60 * 60 * 24));
            if (daysSince >= 2) {
              showNotification(`Subtask "${subtask.title}" untouched for 2 days. Reschedule or delete?`);
            }
          });
          if (task.deadline && !task.completed) {
            const deadline = new Date(task.deadline);
            if (new Date() > deadline) {
              user.exp -= 5;
              user.dailyExp -= 5;
              showNotification(`Missed deadline for "${task.title}". -5 EXP`);
            }
          }
        });
        if (user.dailyTasks === 0) {
          user.stagnationDays += 1;
          if (user.stagnationDays >= 3) {
            showNotification('No progress for 3 days. Let’s get back on track!');
          }
        } else {
          user.stagnationDays = 0;
        }
        if (user.weeklyTasks >= 20) {
          user.exp += 50;
          user.weeklyExp += 50;
          showNotification('Weekly challenge completed! +50 EXP');
        }
        user.dailyTasks = 0;
        user.dailyExp = 0;
        user.dailyPomodoro = 0;
        user.lastActivityDate = today;
        user.lastPomodoroDate = today;
        if (new Date().getDay() === 1) {
          user.weeklyTasks = 0;
          user.weeklyExp = 0;
          user.weeklyStreak = 0;
        }
        if (new Date().getDate() === 1) {
          user.monthlyTasks = 0;
          user.monthlyExp = 0;
        }
        saveState();
        updateUI();
      }
    }

    // Initialize
    loadState();
    setInterval(checkDailyPenalties, 60 * 1000);
  </script>
</body>
</html>